<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Explorer - Genre-Based Suggestions</title>
<style>
body { font-family: Arial, sans-serif; background:#121212; color:white; padding:20px; margin:0; }
input, button { padding:10px; margin:5px 0; width:100%; font-size:16px; border-radius:5px; border:none; }
button { background:#1DB954; color:white; cursor:pointer; }
button:hover { background:#1ed760cc; }
h2,h3 { margin:10px 0 5px; }
.recommendations-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:12px; margin-top:15px; }
.recommendation-card { position:relative; cursor:pointer; transition:transform 0.2s; }
.recommendation-card:hover { transform:scale(1.05); }
.recommendation-card img { width:100%; height:120px; border-radius:6px; display:block; }
.tooltip { visibility:hidden; background-color:rgba(0,0,0,0.8); color:#fff; text-align:left; border-radius:5px; padding:6px; position:absolute; bottom:130px; left:50%; transform:translateX(-50%); width:180px; z-index:1; font-size:12px; }
.recommendation-card:hover .tooltip { visibility:visible; }
@media(max-width:600px){
  .recommendations-grid { grid-template-columns:repeat(auto-fill, minmax(100px,1fr)); }
  .recommendation-card img { height:100px; }
  .tooltip { bottom:110px; width:140px; font-size:11px; }
}
</style>
</head>
<body>
<h1>Spotify Explorer</h1>
<p>Type a song or artist to discover similar songs and artists by genre.</p>
<input type="text" id="query" placeholder="Enter song or artist name">
<button onclick="search()">Search</button>
<div id="results"></div>

<script>
const CLIENT_ID="d88fadc432d04cedadf4ec53368e1b4b";
const REDIRECT_URI="https://slawsimulation.github.io/spotify-explorer/";
const SCOPE="user-read-private user-read-email";
const AUTH_URL="https://accounts.spotify.com/authorize";
const TOKEN_URL="https://accounts.spotify.com/api/token";
let token=null;

// --- PKCE helpers ---
function generateRandomString(length){const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<length;i++)r+=chars.charAt(Math.floor(Math.random()*chars.length));return r;}
function base64UrlEncode(str){return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(str){const encoder=new TextEncoder();const data=encoder.encode(str);const hashBuffer=await crypto.subtle.digest('SHA-256',data);return base64UrlEncode(String.fromCharCode(...new Uint8Array(hashBuffer)));}

async function redirectToSpotifyLogin(){
  const codeVerifier=generateRandomString(128);
  const codeChallenge=await sha256(codeVerifier);
  localStorage.setItem("code_verifier",codeVerifier);
  const url=new URL(AUTH_URL);
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id",CLIENT_ID);
  url.searchParams.set("redirect_uri",REDIRECT_URI);
  url.searchParams.set("scope",SCOPE);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge",codeChallenge);
  window.location.href=url.toString();
}

async function exchangeCodeForToken(code){
  const codeVerifier=localStorage.getItem("code_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:CLIENT_ID,code_verifier:codeVerifier});
  const res=await fetch(TOKEN_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body.toString()});
  const data=await res.json();
  token=data.access_token;
  localStorage.removeItem("code_verifier");
}

async function handleRedirect(){
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");
  if(code){await exchangeCodeForToken(code);window.history.replaceState({},document.title,window.location.pathname);}
  if(!token) redirectToSpotifyLogin();
}

// --- Safe fetch helper ---
async function safeFetch(url){
  try{
    const res=await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
    if(!res.ok) return null;
    return await res.json();
  }catch(e){console.warn("Fetch error:", url,e); return null;}
}

// --- Main search ---
async function search(){
  const query=document.getElementById("query").value.trim();
  if(!query) return;
  document.getElementById("results").innerHTML="Searching...";

  // Try track search
  let data=await safeFetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`);
  document.getElementById("results").innerHTML="";
  if(data?.tracks?.items?.length){
    const track=data.tracks.items[0];
    const artist=track.artists[0];
    document.getElementById("results").innerHTML+=`<div class="result"><h2>${track.name} by ${track.artists.map(a=>a.name).join(", ")}</h2><img src="${track.album.images[0]?.url||''}"/><br><a href="${track.external_urls.spotify}" target="_blank">Open on Spotify</a></div>`;
    await getSuggestions(artist, track);
    return;
  }

  // Fallback to artist search
  data=await safeFetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=artist&limit=1`);
  if(data?.artists?.items?.length){
    const artist=data.artists.items[0];
    document.getElementById("results").innerHTML+=`<div class="result"><h2>Artist: ${artist.name}</h2><img src="${artist.images[0]?.url||''}"/><br><a href="${artist.external_urls.spotify}" target="_blank">Open on Spotify</a></div>`;
    await getSuggestions(artist);
    return;
  }

  document.getElementById("results").innerHTML="No track or artist found.";
}

// --- Suggestions with genre-based filtering ---
async function getSuggestions(artist, track=null){
  const markets=["US","GB","FR","DE","AU"];
  let found=false;
  const grid=document.createElement("div"); grid.className="recommendations-grid";

  // 1️⃣ Related artists → top tracks
  const relatedData=await safeFetch(`https://api.spotify.com/v1/artists/${artist.id}/related-artists`);
  if(relatedData?.artists?.length){
    for(let rArtist of relatedData.artists.slice(0,5)){
      for(let market of markets){
        const topData=await safeFetch(`https://api.spotify.com/v1/artists/${rArtist.id}/top-tracks?market=${market}`);
        if(topData?.tracks?.length){
          topData.tracks.slice(0,2).forEach(t=>{
            if(track && t.artists.some(a=>a.id===track.artists[0].id)) return;
            const img=t.album.images[0]?.url||'';
            const genreText = rArtist.genres.join(", ") || "Unknown genre";
            const card=document.createElement("div");
            card.className="recommendation-card";
            card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank">
              <img src="${img}">
              <div class="tooltip">
                ${t.name}<br>
                by ${t.artists.map(a=>a.name).join(", ")}<br>
                Album: ${t.album.name}<br>
                Genre(s): ${genreText}
              </div>
            </a>`;
            grid.appendChild(card);
            found=true;
          });
          break;
        }
      }
    }
  }

  // 2️⃣ Genre-based fallback using the input artist's genres
  if(artist.genres?.length){
    for(const genre of artist.genres){
      const genreData=await safeFetch(`https://api.spotify.com/v1/search?q=genre:"${encodeURIComponent(genre)}"&type=track&limit=10`);
      if(genreData?.tracks?.items?.length){
        genreData.tracks.items.forEach(t=>{
          const img=t.album.images[0]?.url||'';
          const trackArtist = t.artists[0];
          const trackGenre = trackArtist.genres?.join(", ") || genre;
          const card=document.createElement("div");
          card.className="recommendation-card";
          card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank">
            <img src="${img}">
            <div class="tooltip">
              ${t.name}<br>
              by ${t.artists.map(a=>a.name).join(", ")}<br>
              Album: ${t.album.name}<br>
              Genre(s): ${trackGenre}
            </div>
          </a>`;
          grid.appendChild(card);
          found=true;
        });
      }
      if(found) break; // stop after first genre that returns results
    }
  }

  // 3️⃣ Track keyword search as last fallback
  if(!found && track){
    const keywordData=await safeFetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(track.name)}&type=track&limit=10`);
    if(keywordData?.tracks?.items?.length){
      keywordData.tracks.items.forEach(t=>{
        if(t.artists.some(a=>a.id===track.artists[0].id)) return;
        const img=t.album.images[0]?.url||'';
        const trackGenre = t.artists[0]?.genres?.join(", ") || "Unknown genre";
        const card=document.createElement("div");
        card.className="recommendation-card";
        card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank">
          <img src="${img}">
          <div class="tooltip">
            ${t.name}<br>
            by ${t.artists.map(a=>a.name).join(", ")}<br>
            Album: ${t.album.name}<br>
            Genre(s): ${trackGenre}
          </div>
        </a>`;
        grid.appendChild(card);
        found=true;
      });
    }
  }

  if(found) document.getElementById("results").appendChild(grid);
  else document.getElementById("results").innerHTML+="<p>No suggestions found for this song or artist. Try another track or artist.</p>";
}

handleRedirect();
</script>
</body>
</html>
