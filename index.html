<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Explorer - Genre-Based Suggestions</title>
<style>
*{box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:#121212;color:#fff;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;}
header,footer{background:#1DB954;text-align:center;padding:15px;}
header h1, footer p{margin:0;color:#fff;}
main{flex:1;display:flex;flex-direction:column;align-items:center;padding:20px;width:100%;max-width:800px;margin:0 auto;}
p.description{color:#ccc;margin:10px 0 20px;text-align:center;font-size:14px;}
input,button{padding:10px;margin:5px 0;border-radius:6px;border:none;font-size:16px;}
input{width:100%;max-width:400px;background:#1e1e1e;color:#fff;}
input::placeholder{color:#888;}
button{width:100%;max-width:400px;background:#1DB954;color:#fff;cursor:pointer;transition:0.2s;}
button:hover{background:#1ed760cc;}
.result{margin-bottom:15px;text-align:center;}
h2,h3{margin:8px 0 5px;font-size:16px;text-align:center;}
.recommendations-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px;justify-items:center;}
.recommendation-card{position:relative;cursor:pointer;transition:transform 0.2s;width:140px;}
.recommendation-card:hover{transform:scale(1.05);}
.recommendation-card img{width:100%;height:120px;border-radius:6px;display:block;}
.tooltip{visibility:hidden;background:rgba(0,0,0,0.8);color:#fff;text-align:left;border-radius:5px;padding:5px;position:absolute;bottom:130px;left:50%;transform:translateX(-50%);width:180px;font-size:12px;z-index:1;}
.recommendation-card:hover .tooltip{visibility:visible;}
@media(max-width:600px){.recommendations-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr));}.recommendation-card img{height:100px;}.tooltip{bottom:110px;width:140px;font-size:11px;}}
</style>
</head>
<body>
<header>
  <h1>Spotify Explorer</h1>
</header>
<main>
  <p class="description">Type a song or artist to discover similar songs and artists by genre.</p>
  <input type="text" id="query" placeholder="Enter song or artist name">
  <button onclick="search()">Search</button>
  <div id="results"></div>
</main>
<footer>
  <p>Spotify Explorer &copy; 2025</p>
</footer>

<script>
const CLIENT_ID="d88fadc432d04cedadf4ec53368e1b4b";
const REDIRECT_URI="https://slawsimulation.github.io/spotify-explorer/";
const SCOPE="user-read-private user-read-email";
const AUTH_URL="https://accounts.spotify.com/authorize";
const TOKEN_URL="https://accounts.spotify.com/api/token";
let token=null;

// PKCE helpers
function generateRandomString(len){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<len;i++)r+=c.charAt(Math.floor(Math.random()*c.length));return r;}
function base64UrlEncode(s){return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(s){const e=new TextEncoder();const d=e.encode(s);const h=await crypto.subtle.digest('SHA-256',d);return base64UrlEncode(String.fromCharCode(...new Uint8Array(h)));}

async function redirectToSpotifyLogin(){
  const codeVerifier=generateRandomString(128);
  const codeChallenge=await sha256(codeVerifier);
  localStorage.setItem("code_verifier",codeVerifier);
  const url=new URL(AUTH_URL);
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id",CLIENT_ID);
  url.searchParams.set("redirect_uri",REDIRECT_URI);
  url.searchParams.set("scope",SCOPE);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge",codeChallenge);
  window.location.href=url.toString();
}

async function exchangeCodeForToken(code){
  const codeVerifier=localStorage.getItem("code_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:CLIENT_ID,code_verifier:codeVerifier});
  const res=await fetch(TOKEN_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body.toString()});
  const data=await res.json(); token=data.access_token; localStorage.removeItem("code_verifier");
}

async function handleRedirect(){
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");
  if(code){await exchangeCodeForToken(code);window.history.replaceState({},document.title,window.location.pathname);}
  if(!token) redirectToSpotifyLogin();
}

// Safe fetch
async function safeFetch(url){try{const res=await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
if(!res.ok)return null;return await res.json();}catch(e){console.warn("Fetch error:",url,e);return null;}}

// Enter key triggers search
document.getElementById("query").addEventListener("keydown",e=>{if(e.key==="Enter") search();});

// Main search
async function search(){
  const query=document.getElementById("query").value.trim();
  if(!query) return; document.getElementById("results").innerHTML="Searching...";
  let data=await safeFetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`);
  document.getElementById("results").innerHTML="";
  if(data?.tracks?.items?.length){
    const track=data.tracks.items[0]; const artist=track.artists[0];
    document.getElementById("results").innerHTML=`<div class="result"><h2>${track.name} by ${track.artists.map(a=>a.name).join(", ")}</h2><img src="${track.album.images[0]?.url||''}"/><br><a href="${track.external_urls.spotify}" target="_blank">Open on Spotify</a></div>`;
    await getSuggestions(artist,track); return;
  }
  data=await safeFetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=artist&limit=1`);
  if(data?.artists?.items?.length){
    const artist=data.artists.items[0];
    document.getElementById("results").innerHTML=`<div class="result"><h2>Artist: ${artist.name}</h2><img src="${artist.images[0]?.url||''}"/><br><a href="${artist.external_urls.spotify}" target="_blank">Open on Spotify</a></div>`;
    await getSuggestions(artist); return;
  }
  document.getElementById("results").innerHTML="No track or artist found.";
}

// Suggestions
async function getSuggestions(artist, track=null){
  const markets=["US","GB","FR","DE","AU"]; let found=false;
  const grid=document.createElement("div"); grid.className="recommendations-grid";

  const relatedData=await safeFetch(`https://api.spotify.com/v1/artists/${artist.id}/related-artists`);
  if(relatedData?.artists?.length){
    for(let rArtist of relatedData.artists.slice(0,5)){
      for(let market of markets){
        const topData=await safeFetch(`https://api.spotify.com/v1/artists/${rArtist.id}/top-tracks?market=${market}`);
        if(topData?.tracks?.length){
          for(const t of topData.tracks.slice(0,2)){
            if(track && t.artists.some(a=>a.id===track.artists[0].id)) continue;
            const img=t.album.images[0]?.url||'';
            const artistInfo=await safeFetch(`https://api.spotify.com/v1/artists/${t.artists[0].id}`);
            const genreText=artistInfo?.genres?.join(", ")||"Unknown genre";
            const card=document.createElement("div"); card.className="recommendation-card";
            card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank"><img src="${img}"><div class="tooltip">${t.name}<br>by ${t.artists.map(a=>a.name).join(", ")}<br>Album: ${t.album.name}<br>Genre(s): ${genreText}</div></a>`;
            grid.appendChild(card); found=true;
          }
          break;
        }
      }
    }
  }

  if(artist.genres?.length){
    for(const genre of artist.genres){
      const genreData=await safeFetch(`https://api.spotify.com/v1/search?q=genre:"${encodeURIComponent(genre)}"&type=track&limit=10`);
      if(genreData?.tracks?.items?.length){
        for(const t of genreData.tracks.items){
          const img=t.album.images[0]?.url||'';
          const artistInfo=await safeFetch(`https://api.spotify.com/v1/artists/${t.artists[0].id}`);
          const trackGenre=artistInfo?.genres?.join(", ")||genre;
          const card=document.createElement("div"); card.className="recommendation-card";
          card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank"><img src="${img}"><div class="tooltip">${t.name}<br>by ${t.artists.map(a=>a.name).join(", ")}<br>Album: ${t.album.name}<br>Genre(s): ${trackGenre}</div></a>`;
          grid.appendChild(card); found=true;
        }
      }
      if(found) break;
    }
  }

  if(!found && track){
    const keywordData=await safeFetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(track.name)}&type=track&limit=10`);
    if(keywordData?.tracks?.items?.length){
      for(const t of keywordData.tracks.items){
        if(t.artists.some(a=>a.id===track.artists[0].id)) continue;
        const img=t.album.images[0]?.url||'';
        const artistInfo=await safeFetch(`https://api.spotify.com/v1/artists/${t.artists[0].id}`);
        const trackGenre=artistInfo?.genres?.join(", ")||"Unknown genre";
        const card=document.createElement("div"); card.className="recommendation-card";
        card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank"><img src="${img}"><div class="tooltip">${t.name}<br>by ${t.artists.map(a=>a.name).join(", ")}<br>Album: ${t.album.name}<br>Genre(s): ${trackGenre}</div></a>`;
        grid.appendChild(card); found=true;
      }
    }
  }

  if(found) document.getElementById("results").appendChild(grid);
  else document.getElementById("results").innerHTML+="<p>No suggestions found for this song or artist.</p>";
}

handleRedirect();
</script>
</body>
</html>
