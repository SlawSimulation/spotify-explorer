<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Explorer PKCE</title>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: white; padding: 20px; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; font-size: 14px; }
    .result { margin: 10px 0; }
    img { height: 50px; vertical-align: middle; margin-right: 10px; }
    h2, h3 { margin: 10px 0 5px; }
  </style>
</head>
<body>
  <h1>Spotify Song/Artist/Genre Explorer</h1>
  <p>Enter a song, artist, or genre to explore related content.</p>
  <input type="text" id="query" placeholder="Enter song, artist, or genre">
  <button onclick="search()">Search</button>

  <div id="results"></div>

  <script>
    const CLIENT_ID = "d88fadc432d04cedadf4ec53368e1b4b"; // Replace with your Spotify Client ID
    const REDIRECT_URI = "https://slawsimulation.github.io/spotify-explorer/";
    const SCOPE = "user-read-private user-read-email";
    const AUTH_URL = "https://accounts.spotify.com/authorize";
    const TOKEN_URL = "https://accounts.spotify.com/api/token";

    let token = null;

    // Generate random code verifier
    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
      return result;
    }

    // Base64 URL encode
    function base64UrlEncode(str) {
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // SHA-256 hash
    async function sha256(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return base64UrlEncode(String.fromCharCode(...new Uint8Array(hashBuffer)));
    }

    async function redirectToSpotifyLogin() {
      const codeVerifier = generateRandomString(128);
      const codeChallenge = await sha256(codeVerifier);
      localStorage.setItem("code_verifier", codeVerifier);

      const url = new URL(AUTH_URL);
      url.searchParams.set("response_type", "code");
      url.searchParams.set("client_id", CLIENT_ID);
      url.searchParams.set("redirect_uri", REDIRECT_URI);
      url.searchParams.set("scope", SCOPE);
      url.searchParams.set("code_challenge_method", "S256");
      url.searchParams.set("code_challenge", codeChallenge);

      window.location.href = url.toString();
    }

    async function exchangeCodeForToken(code) {
      const codeVerifier = localStorage.getItem("code_verifier");
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code: code,
        redirect_uri: REDIRECT_URI,
        client_id: CLIENT_ID,
        code_verifier: codeVerifier
      });

      const res = await fetch(TOKEN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      });

      const data = await res.json();
      token = data.access_token;
      localStorage.removeItem("code_verifier");
    }

    async function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (code) {
        await exchangeCodeForToken(code);
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      if (!token) {
        redirectToSpotifyLogin();
      }
    }

    async function search() {
      const query = document.getElementById("query").value;
      if (!query) return;
      document.getElementById("results").innerHTML = "Searching...";

      const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track,artist&limit=1`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      document.getElementById("results").innerHTML = "";

      if (data.artists?.items?.length > 0) {
        showArtist(data.artists.items[0]);
        getRelatedArtists(data.artists.items[0].id);
      } else if (data.tracks?.items?.length > 0) {
        showTrack(data.tracks.items[0]);
        getRecommendations(data.tracks.items[0].id);
      } else {
        document.getElementById("results").innerHTML = "No results found.";
      }
    }

    function showArtist(artist) {
      document.getElementById("results").innerHTML += `
        <div class="result">
          <h2>Artist: ${artist.name}</h2>
          <p>Genres: ${artist.genres.join(", ")}</p>
          <img src="${artist.images[0]?.url || ''}" />
        </div>`;
    }

    function showTrack(track) {
      document.getElementById("results").innerHTML += `
        <div class="result">
          <h2>Track: ${track.name} by ${track.artists[0].name}</h2>
          <img src="${track.album.images[0]?.url || ''}" />
        </div>`;
    }

    async function getRelatedArtists(artistId) {
      const res = await fetch(`https://api.spotify.com/v1/artists/${artistId}/related-artists`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.artists?.length > 0) {
        document.getElementById("results").innerHTML += "<h3>Similar Artists:</h3>";
        data.artists.slice(0,5).forEach(a => {
          document.getElementById("results").innerHTML += `<p>${a.name}</p>`;
        });
      }
    }

    async function getRecommendations(trackId) {
      const res = await fetch(`https://api.spotify.com/v1/recommendations?seed_tracks=${trackId}&limit=5`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.tracks?.length > 0) {
        document.getElementById("results").innerHTML += "<h3>Recommended Songs:</h3>";
        data.tracks.forEach(t => {
          document.getElementById("results").innerHTML += `<p>${t.name} by ${t.artists[0].name}</p>`;
        });
      }
    }

    handleRedirect();
  </script>
</body>
</html>
