<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Explorer - Similar Songs & Artists</title>
<style>
body { font-family: Arial, sans-serif; background:#121212; color:white; padding:20px; margin:0; }
input, button { padding:10px; margin:5px 0; width:100%; font-size:16px; border-radius:5px; border:none; }
button { background:#1DB954; color:white; cursor:pointer; }
button:hover { background:#1ed760cc; }
h2,h3 { margin:10px 0 5px; }
.recommendations-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:12px; margin-top:15px; }
.recommendation-card { position:relative; cursor:pointer; transition:transform 0.2s; }
.recommendation-card:hover { transform:scale(1.05); }
.recommendation-card img { width:100%; height:120px; border-radius:6px; display:block; }
.tooltip { visibility:hidden; background-color:rgba(0,0,0,0.8); color:#fff; text-align:left; border-radius:5px; padding:6px; position:absolute; bottom:130px; left:50%; transform:translateX(-50%); width:180px; z-index:1; font-size:12px; }
.recommendation-card:hover .tooltip { visibility:visible; }
@media(max-width:600px){
  .recommendations-grid { grid-template-columns:repeat(auto-fill, minmax(100px,1fr)); }
  .recommendation-card img { height:100px; }
  .tooltip { bottom:110px; width:140px; font-size:11px; }
}
</style>
</head>
<body>
<h1>Spotify Explorer</h1>
<p>Type a song or artist to discover similar songs and artists.</p>
<input type="text" id="query" placeholder="Enter song or artist name">
<button onclick="search()">Search</button>
<div id="results"></div>

<script>
const CLIENT_ID="d88fadc432d04cedadf4ec53368e1b4b";
const REDIRECT_URI="https://slawsimulation.github.io/spotify-explorer/";
const SCOPE="user-read-private user-read-email";
const AUTH_URL="https://accounts.spotify.com/authorize";
const TOKEN_URL="https://accounts.spotify.com/api/token";
let token=null;

// --- PKCE helpers ---
function generateRandomString(length){const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<length;i++)r+=chars.charAt(Math.floor(Math.random()*chars.length));return r;}
function base64UrlEncode(str){return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(str){const encoder=new TextEncoder();const data=encoder.encode(str);const hashBuffer=await crypto.subtle.digest('SHA-256',data);return base64UrlEncode(String.fromCharCode(...new Uint8Array(hashBuffer)));}

async function redirectToSpotifyLogin(){
  const codeVerifier=generateRandomString(128);
  const codeChallenge=await sha256(codeVerifier);
  localStorage.setItem("code_verifier",codeVerifier);
  const url=new URL(AUTH_URL);
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id",CLIENT_ID);
  url.searchParams.set("redirect_uri",REDIRECT_URI);
  url.searchParams.set("scope",SCOPE);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge",codeChallenge);
  window.location.href=url.toString();
}

async function exchangeCodeForToken(code){
  const codeVerifier=localStorage.getItem("code_verifier");
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:CLIENT_ID,code_verifier:codeVerifier});
  const res=await fetch(TOKEN_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body.toString()});
  const data=await res.json();
  token=data.access_token;
  localStorage.removeItem("code_verifier");
}

async function handleRedirect(){
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");
  if(code){await exchangeCodeForToken(code);window.history.replaceState({},document.title,window.location.pathname);}
  if(!token) redirectToSpotifyLogin();
}

// --- Main search ---
async function search(){
  const query=document.getElementById("query").value.trim();
  if(!query) return;
  document.getElementById("results").innerHTML="Searching...";

  // Try track search first
  let res=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`,{headers:{Authorization:`Bearer ${token}`}});
  let data=await res.json();
  document.getElementById("results").innerHTML="";
  if(data.tracks?.items?.length>0){
    const track=data.tracks.items[0];
    const artist=track.artists[0];
    document.getElementById("results").innerHTML+=`<div class="result"><h2>${track.name} by ${track.artists.map(a=>a.name).join(", ")}</h2><img src="${track.album.images[0]?.url||''}"/><br><a href="${track.external_urls.spotify}" target="_blank">Open on Spotify</a></div>`;
    await getRelatedTracksAndArtists(artist, track);
    return;
  }

  // Fallback to artist search
  res=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=artist&limit=1`,{headers:{Authorization:`Bearer ${token}`}});
  data=await res.json();
  if(data.artists?.items?.length>0){
    const artist=data.artists.items[0];
    document.getElementById("results").innerHTML+=`<div class="result"><h2>Artist: ${artist.name}</h2><img src="${artist.images[0]?.url||''}"/><br><a href="${artist.external_urls.spotify}" target="_blank">Open on Spotify</a></div>`;
    await getRelatedTracksAndArtists(artist);
    return;
  }

  document.getElementById("results").innerHTML="No track or artist found.";
}

// --- Related tracks & artists with genre fallback ---
async function getRelatedTracksAndArtists(artist, track=null){
  const markets=["US","GB","FR","DE","AU"];
  let foundRelated=false;

  // Try related artists
  try{
    const res=await fetch(`https://api.spotify.com/v1/artists/${artist.id}/related-artists`, {headers:{Authorization:`Bearer ${token}`}});
    if(res.ok){
      const data=await res.json();
      if(data.artists?.length){
        foundRelated=true;
        document.getElementById("results").innerHTML+="<h3>Similar Artists & Their Top Tracks:</h3>";
        const grid=document.createElement("div"); grid.className="recommendations-grid";

        for(let rArtist of data.artists.slice(0,5)){
          let trackAdded=false;
          for(let market of markets){
            const topRes=await fetch(`https://api.spotify.com/v1/artists/${rArtist.id}/top-tracks?market=${market}`, {headers:{Authorization:`Bearer ${token}`}});
            const topData=await topRes.json();
            if(!topData.tracks?.length) continue;
            topData.tracks.slice(0,2).forEach(t=>{
              if(track && t.artists.some(a=>a.id===track.artists[0].id)) return;
              const img=t.album.images[0]?.url||'';
              const card=document.createElement("div");
              card.className="recommendation-card";
              card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank"><img src="${img}"><div class="tooltip">${t.name}<br>by ${t.artists.map(a=>a.name).join(", ")}<br>Album: ${t.album.name}</div></a>`;
              grid.appendChild(card);
              trackAdded=true;
            });
            if(trackAdded) break;
          }
        }
        document.getElementById("results").appendChild(grid);
      }
    }
  } catch(e){console.warn("No related artists for", artist.name, e);}

  // Fallback: genre-based tracks
  if(!foundRelated && artist.genres?.length){
    const genre=artist.genres[0];
    const res=await fetch(`https://api.spotify.com/v1/search?q=genre:"${encodeURIComponent(genre)}"&type=track&limit=10`, {headers:{Authorization:`Bearer ${token}`}});
    const data=await res.json();
    if(data.tracks?.items?.length){
      document.getElementById("results").innerHTML+="<h3>Tracks in the same genre:</h3>";
      const grid=document.createElement("div"); grid.className="recommendations-grid";
      data.tracks.items.forEach(t=>{
        const img=t.album.images[0]?.url||'';
        const card=document.createElement("div");
        card.className="recommendation-card";
        card.innerHTML=`<a href="${t.external_urls.spotify}" target="_blank"><img src="${img}"><div class="tooltip">${t.name}<br>by ${t.artists.map(a=>a.name).join(", ")}<br>Album: ${t.album.name}</div></a>`;
        grid.appendChild(card);
      });
      document.getElementById("results").appendChild(grid);
    }
  }
}

handleRedirect();
</script>
</body>
</html>
